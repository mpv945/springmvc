<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:batch="http://www.springframework.org/schema/batch"
       xsi:schemaLocation="
       http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <batch:job id="mybatisPagingReadJob">
        <batch:step id="ibatisPagingReadStep">
            <tasklet transaction-manager="transactionManager">
                <chunk reader="mybatisPagingItemReader" processor="creditBillProcessor"
                       writer="creditItemWriter" commit-interval="2"></chunk>
            </tasklet>
        </batch:step>
    </batch:job>

    <!-- mybatis正常读取数据库 需要引入mybatis和mybatis-spring -->
    <bean id="mybatisPagingItemReader" scope="step" class="org.mybatis.spring.batch.MyBatisCursorItemReader">
        <!-- <bean:property name="queryId" value="getAllCredits" /> -->
        <property name="queryId" value="deleteByPrimaryKey" /><!--命名SQL定义的id-->
        <property name="sqlSessionFactory" ref="sqlSessionFactory" /><!--指定执行命名空间SQL的配置文件和数据源-->
        <property name="parameterValues"><!--定义sql参数，类型Map<String,Object>-->
            <map>
                <entry key="begin" value="#{jobParameters['id_begin']}" />
                <entry key="end" value="#{jobParameters['id_end']}" />
            </map>
        </property>
    </bean>
    <!--分页读取-->
    <bean id="mybatisPagingItemReader" class="org.mybatis.spring.batch.MyBatisPagingItemReader">
        <property name="queryId" value="deleteByPrimaryKey" /><!--命名SQL定义的id-->
        <property name="sqlSessionFactory" ref="sqlSessionFactory" />
        <property name="parameterValues"><!--定义sql参数，类型Map<String,Object>-->
            <map>
                <entry key="begin" value="#{jobParameters['id_begin']}" />
                <entry key="end" value="#{jobParameters['id_end']}" />
            </map>
        </property>
        <property name="pageSize" value="12" /><!-- 每页条数-->
    </bean>

    <!--mybatis 写入-->
    <bean class="org.mybatis.spring.batch.MyBatisBatchItemWriter" id="batchItemWriter">
        <property name="statementId" value="insertDestCredits" /><!-- 命名sql定义的ID, 插入，更新，删除参数类型就用处理Item类型数据，具体参考insertDestCredits-->
        <property name="sqlSessionFactory" ref="sqlSessionFactory" /><!--指定命名sql的配置文件和数据源-->
        <property name="assertUpdates" value="true" /><!--是否断言执行的sql对数据库有记录更新，如果没有更新会抱出EmptyResultDataAccessException-->
    </bean>


    <bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
        <property name="dataSource" ref="dataSource" />
        <!--扫描映射文件-->
        <property name="mapperLocations">
            <array>
                <value>classpath:mapper/*.xml</value>
            </array>
        </property>
        <!-- 自动扫描mapping.xml文件，**表示迭代查找,也可在sqlMapConfig.xml中单独指定xml文件-->
        <!--<property name="mapperLocations" value="classpath:com/hua/saf/**/*.xml" />-->
        <property name="typeAliasesPackage" value="org.haijun.study.mybatis" /><!--实体包路径-->
        <!--暂时不要分页-->
<!--        <property name="plugins">
            <array>
                <bean class="com.github.pagehelper.PageInterceptor">
                    <property name="properties">
                        <value>
                            helperDialect=mysql
                            reasonable=true
                            supportMethodsArguments=true
                            params=count=countSql
                            autoRuntimeDialect=true
                        </value>
                    </property>
                </bean>
            </array>
        </property>-->
    </bean>
    <!-- 配置事务管理器，注意这里的dataSource和SqlSessionFactoryBean的dataSource要一致，不然事务就没有作用了 -->
    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource" />
    </bean>

    <bean id="creditBillProcessor" scope="step" class="org.haijun.study.processor.CreditBillProcessor"></bean>

</beans>