<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:batch="http://www.springframework.org/schema/batch"
       xsi:schemaLocation="
       http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <batch:step id="parentReadWriteStep" abstract="true">
         <batch:tasklet transaction-manager="transactionManager">
            <batch:chunk reader="flatFileItemReader" writer="flatFileItemWriter"
                processor="creditBillProcessor" commit-interval="2">
            </batch:chunk>
         </batch:tasklet>
    </batch:step>
    
    <bean id="flatFileItemWriter" scope="step"
        class="org.springframework.batch.item.file.FlatFileItemWriter">
        <property name="resource" value="#{jobExecutionContext['writeFile']}"/>
        <property name="lineAggregator" ref="lineAggregator"/>
    </bean>
    
    <bean id="lineAggregator" class="org.springframework.batch.item.file.transform.DelimitedLineAggregator">
         <property name="delimiter" value=","></property>
         <property name="fieldExtractor">
             <bean
                 class="org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor">
                 <property name="names"
                      value="accountID,name,amount,date,address">
                 </property>
             </bean>
         </property>
     </bean>
     
    <bean id="flatFileItemReader" scope="step"
        class="org.springframework.batch.item.file.FlatFileItemReader">
        <property name="resource"
            value="#{jobExecutionContext['readFile']}"/>
        <property name="lineMapper" ref="lineMapper" />
    </bean>
    
	<bean id="lineMapper"
	    class="org.springframework.batch.item.file.mapping.DefaultLineMapper" >
	    <property name="lineTokenizer" ref="delimitedLineTokenizer" />
	    <property name="fieldSetMapper" ref="creditBillFieldSetMapper"/>
	</bean>
            
    <bean id="delimitedLineTokenizer"
        class="org.springframework.batch.item.file.transform.DelimitedLineTokenizer">
        <property name="delimiter" value=","/>
        <property name="names" value="accountID,name,amount,date,address" />
    </bean>

    <bean id="creditBillFieldSetMapper"
        class="org.haijun.study.flow.chunk.CreditBillFieldSetMapper">
    </bean>
    
    <bean id="creditBill" scope="prototype"
        class="org.haijun.study.flow.chunk.CreditBill">
    </bean>
    
    <bean id="creditBillProcessor" scope="step"
        class="org.haijun.study.flow.chunk.CreditBillProcessor">
    </bean>
        
</beans>